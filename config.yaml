mqtt:
  broker: ${MQTT_BROKER:-localhost}
  port: ${MQTT_PORT:-1883}
  # Client ID for the Smart Metering & Control service
  client_id: smart-meter-control
  topic_prefix: zeropower
  # OpenDTU MQTT topic prefix (configured in OpenDTU web UI)
  opendtu_topic: solar

opendtu:
  # IP address of the OpenDTU device (ESP32)
  ip: ${OPENDTU_IP:-192.168.1.50}
  # OpenDTU Web UI credentials (if protected)
  user: ${OPENDTU_USER:-admin}
  password: ${OPENDTU_PASS:-secret}

powermeter:
  # Supported types: shelly_em, shelly_3em, shelly_3em_pro
  type: shelly_em
  # IP address of the Shelly power meter
  ip: ${SHELLY_IP:-192.168.1.60}
  # Auth for Shelly (Generation 2 devices use 'admin' as user)
  user: ${SHELLY_USER:-admin}
  password: ${SHELLY_PASS:-}
  # For Shelly EM, specify which channel (0 or 1)
  emeter_index: 0
  # How often to poll the meter via HTTP (seconds)
  poll_interval_s: 1

control:
  # Desired grid setpoint in Watts (negative = feed-in, positive = import)
  # 30W import ensures strict zero export even with measurement fluctuation
  target_point_w: 30
  # Deadband: no action if usage is within target +/- tolerance
  tolerance_w: 15
  # Max power reading to consider as valid
  max_point_w: 50
  # If grid goes below this (exporting), immediate action is taken
  min_point_w: 0
  # Main control loop interval (seconds)
  loop_interval_s: 5
  # Timeout for inverter limit ACK
  set_limit_timeout_s: 5

  # PID Controller Parameters
  # Tuned for typical residential setups with moderate latency
  kp: 0.8   # Proportional gain
  ki: 0.15  # Integral gain
  kd: 0.05  # Derivative gain
  # Anti-windup clamping for integral term
  integral_max: 500
  
  # Advanced Grid Protection
  # If grid import jumps above a threshold, immediately cut power? (%)
  on_grid_jump_percent: 0
  # If feeding in to grid, decrease limit faster than normal PID?
  fast_limit_decrease: true

inverters:
  # List all your inverters here
  - serial: "1141xxxxxxxxx"  # Replace with actual inverter serial
    enabled: true
    max_watt: 1200           # Inverter max rating
    inverter_watt: 1200      # Soft limit if desired (same as max usually)
    min_watt_percent: 5      # Minimum power % (usually 2-5%)
    compensate_factor: 1.0   # Multiplier for calibration (1.0 = no change)
    battery_mode: false      # Set true if using battery (different logic may apply)

influxdb:
  url: ${INFLUXDB_URL:-http://localhost:8086}
  token: ${INFLUXDB_TOKEN:-my-super-secret-auth-token}
  org: ${INFLUXDB_ORG:-solar}
  bucket: ${INFLUXDB_BUCKET:-zero_export}

logging:
  level: INFO
  to_file: false
